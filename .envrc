# .envrc -- Connect IQ SDK (macOS) via direnv

set -euo pipefail

CIQ_CURRENT_SDK_CFG="$HOME/Library/Application Support/Garmin/ConnectIQ/current-sdk.cfg"

if [[ ! -f "$CIQ_CURRENT_SDK_CFG" ]]; then
  echo "direnv: Connect IQ SDK not found."
  echo "direnv: missing $CIQ_CURRENT_SDK_CFG"
  return 1
fi

# current-sdk.cfg contains the absolute path to the SDK root directory
export CIQ_SDK_HOME
CIQ_SDK_HOME="$(cat "$CIQ_CURRENT_SDK_CFG")"

if [[ ! -d "$CIQ_SDK_HOME" ]]; then
  echo "direnv: CIQ_SDK_HOME points to a non-existent directory:"
  echo "direnv: $CIQ_SDK_HOME"
  return 1
fi

if [[ ! -x "$CIQ_SDK_HOME/bin/monkeyc" ]]; then
  echo "direnv: monkeyc not found or not executable at:"
  echo "direnv: $CIQ_SDK_HOME/bin/monkeyc"
  return 1
fi

# Put Connect IQ tools on PATH
PATH_add "$CIQ_SDK_HOME/bin"

# Optional -- set your dev key if you keep it in the repo.
# You can generate one via Garmin tools/UI; name/location is up to you.
if [[ -f "$PWD/developer_key.der" ]]; then
  export CIQ_DEVELOPER_KEY="$PWD/developer_key.der"
fi

export JAVA_TOOL_OPTIONS=-Djava.awt.headless=true

# Nice-to-have -- quick visibility when entering the directory
# (comment out if you prefer silence)
echo "direnv: CIQ_SDK_HOME=$CIQ_SDK_HOME"

